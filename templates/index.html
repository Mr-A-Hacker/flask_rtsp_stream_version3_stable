<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Camera Dashboard</title>

    <style>
        body {
            margin: 0;
            background: #111;
            color: #eee;
            font-family: Arial, sans-serif;
            text-align: center;
        }

        #video-wrapper {
            position: relative;
            display: inline-block;
            margin-top: 20px;
        }

        /* FIXED SIZE TO MATCH BACKEND (960x540) */
        #stream {
            width: 960px;
            height: 540px;
            border: 2px solid #333;
            border-radius: 6px;
        }

        #boxCanvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 20;
            cursor: crosshair;
            display: none;
        }

        .overlay-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0,0,0,0.6);
            color: #fff;
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            z-index: 30;
        }

        #settings-btn {
            right: 60px;
        }

        #settings-panel {
            position: absolute;
            top: 60px;
            right: 20px;
            width: 260px;
            background: #1c1c1c;
            border: 1px solid #333;
            padding: 15px;
            display: none;
            border-radius: 6px;
            z-index: 40;
        }

        .settings-btn {
            width: 100%;
            padding: 10px;
            margin-top: 8px;
            background: #333;
            border: none;
            color: #fff;
            cursor: pointer;
            border-radius: 4px;
        }

        .settings-btn:hover {
            background: #444;
        }

        /* Alarm Popup */
        #alarm-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #222;
            padding: 20px;
            border: 2px solid #444;
            border-radius: 8px;
            display: none;
            z-index: 999;
            color: white;
            width: 300px;
            text-align: center;
        }

        #alarm-list {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }

        .alarm-btn {
            width: 100%;
            padding: 10px;
            margin-top: 6px;
            background: #333;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }

        .alarm-btn:hover {
            background: #444;
        }

        #close-alarm-popup {
            margin-top: 10px;
            padding: 8px 12px;
            background: #444;
            border: none;
            color: white;
            border-radius: 4px;
            cursor: pointer;
        }
    </style>
</head>
<body>

<div id="video-wrapper">
    <img id="stream" src="/video">
    <canvas id="boxCanvas"></canvas>

    <button id="settings-btn" class="overlay-btn" onclick="toggleSettings()">⚙</button>
    <button id="fullscreen-btn" class="overlay-btn" onclick="toggleFullscreen()">⛶</button>

    <div id="settings-panel">
        <h3>Settings</h3>

        <!-- Alarm Box Controls -->
        <button class="settings-btn" onclick="startBoxDrawing()">Draw Alarm Box</button>
        <button class="settings-btn" onclick="toggleAlarmBox()">Toggle Alarm Box</button>
        <button class="settings-btn" onclick="toggleAlarmBoxVisibility()">Show/Hide Alarm Box</button>

        <!-- YOLO Controls -->
        <button class="settings-btn" onclick="toggleYoloBoxes()">Show/Hide YOLO Boxes</button>
        <button class="settings-btn" onclick="toggleMovement()">Toggle Movement Detection</button>

        <!-- Alarm Sound -->
        <button class="settings-btn" onclick="chooseAlarm()">Choose Alarm Sound</button>
    </div>
</div>

<!-- Alarm Selection Popup -->
<div id="alarm-popup">
    <h3>Select Alarm</h3>
    <div id="alarm-list"></div>
    <button id="close-alarm-popup" onclick="closeAlarmPopup()">Close</button>
</div>

<script>
/* Ensure canvas always matches video */
function resizeCanvasToVideo() {
    const video = document.getElementById("stream");
    boxCanvas.width = video.clientWidth;
    boxCanvas.height = video.clientHeight;
}
window.onload = resizeCanvasToVideo;
window.onresize = resizeCanvasToVideo;

/* SETTINGS PANEL */
function toggleSettings() {
    const panel = document.getElementById("settings-panel");
    panel.style.display = (panel.style.display === "block") ? "none" : "block";
}

/* FULLSCREEN */
function toggleFullscreen() {
    const video = document.getElementById("stream");
    if (!document.fullscreenElement) video.requestFullscreen();
    else document.exitFullscreen();
}

/* DRAW BOX — AUTO‑SAVE VERSION */
let boxStart = null;
let boxEnd = null;
let drawing = false;
const boxCanvas = document.getElementById("boxCanvas");
const boxCtx = boxCanvas.getContext("2d");

function startBoxDrawing() {
    resizeCanvasToVideo();
    boxCanvas.style.display = "block";
    drawing = true;
    boxStart = null;
    boxEnd = null;
    boxCtx.clearRect(0, 0, boxCanvas.width, boxCanvas.height);
}

boxCanvas.addEventListener("mousedown", e => {
    if (!drawing) return;
    const r = boxCanvas.getBoundingClientRect();
    boxStart = { x: e.clientX - r.left, y: e.clientY - r.top };
});

boxCanvas.addEventListener("mousemove", e => {
    if (!drawing || !boxStart) return;
    const r = boxCanvas.getBoundingClientRect();
    boxEnd = { x: e.clientX - r.left, y: e.clientY - r.top };

    boxCtx.clearRect(0, 0, boxCanvas.width, boxCanvas.height);
    boxCtx.strokeStyle = "red";
    boxCtx.lineWidth = 2;
    boxCtx.strokeRect(
        boxStart.x,
        boxStart.y,
        boxEnd.x - boxStart.x,
        boxEnd.y - boxStart.y
    );
});

/* AUTO‑SAVE ON MOUSE UP */
boxCanvas.addEventListener("mouseup", e => {
    if (!drawing || !boxStart || !boxEnd) return;

    const x1 = Math.min(boxStart.x, boxEnd.x);
    const y1 = Math.min(boxStart.y, boxEnd.y);
    const x2 = Math.max(boxStart.x, boxEnd.x);
    const y2 = Math.max(boxStart.y, boxEnd.y);

    // NORMALIZED COORDINATES
    const nx1 = x1 / boxCanvas.width;
    const ny1 = y1 / boxCanvas.height;
    const nx2 = x2 / boxCanvas.width;
    const ny2 = y2 / boxCanvas.height;

    fetch("/save_box", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ box_norm: [nx1, ny1, nx2, ny2] })
    }).then(() => {
        alert("Box saved");
        boxCanvas.style.display = "none";
        drawing = false;
    });
});

/* BACKEND TOGGLES */
function toggleAlarmBox() {
    fetch("/toggle_alarm_box", { method: "POST" })
        .then(r => r.json())
        .then(data => alert("Alarm Box: " + (data.enabled ? "ON" : "OFF")));
}

function toggleAlarmBoxVisibility() {
    fetch("/toggle_box_visibility", { method: "POST" })
        .then(r => r.json())
        .then(data => alert("Alarm Box Visible: " + data.visible));
}

function toggleYoloBoxes() {
    fetch("/toggle_yolo_boxes", { method: "POST" })
        .then(r => r.json())
        .then(data => alert("YOLO Boxes: " + (data.enabled ? "ON" : "OFF")));
}

function toggleMovement() {
    fetch("/toggle_movement_detection", { method: "POST" })
        .then(r => r.json())
        .then(data => alert("Movement Detection: " + (data.enabled ? "ON" : "OFF")));
}

/* ALARM POPUP */
function chooseAlarm() {
    fetch("/list_alarms")
        .then(r => r.json())
        .then(files => {
            const listDiv = document.getElementById("alarm-list");
            listDiv.innerHTML = "";

            files.forEach(file => {
                const btn = document.createElement("button");
                btn.textContent = file;
                btn.className = "alarm-btn";
                btn.onclick = () => {
                    fetch("/set_alarm", {
                        method: "POST",
                        headers: {"Content-Type": "application/json"},
                        body: JSON.stringify({ filename: file })
                    });
                    closeAlarmPopup();
                };
                listDiv.appendChild(btn);
            });

            document.getElementById("alarm-popup").style.display = "block";
        });
}

function closeAlarmPopup() {
    document.getElementById("alarm-popup").style.display = "none";
}
</script>

</body>
</html>
